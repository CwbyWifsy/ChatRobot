<<<<<<< HEAD
# å°è¯´ RAG æœåŠ¡

è¯¥é¡¹ç›®å®žçŽ°äº†ä¸€ä¸ªåŸºäºŽ Milvus çš„å°è¯´æ£€ç´¢å¢žå¼ºç”Ÿæˆï¼ˆRAGï¼‰ç³»ç»Ÿï¼Œæ”¯æŒæœ¬åœ° Qwen3-0.6B å‘é‡åŒ–æ¨¡åž‹ã€OpenAI å…¼å®¹å¯¹è¯æ¨¡åž‹ä»¥åŠå°è¯´åˆ†ç« èŠ‚ä¸Šä¼ æµç¨‹ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ðŸ“š **å°è¯´ç®¡ç†**ï¼šé€šè¿‡å¼‚æ­¥ Python è„šæœ¬æ‰¹é‡è¯»å– UTF-8 TXT å°è¯´ï¼Œè‡ªåŠ¨æ£€æµ‹ç« èŠ‚å¹¶æŒ‰é‡å çª—å£åˆ‡åˆ†ã€‚
- ðŸ§¾ **å“ˆå¸ŒåŽ»é‡**ï¼šåŸºäºŽæ–‡ä»¶å + å†…å®¹ + ç”¨æˆ·ç¡®è®¤çš„ä¹¦åç”Ÿæˆå“ˆå¸Œï¼Œé¿å…é‡å¤å…¥åº“ï¼Œå¹¶æ”¯æŒæ‰‹åŠ¨è¦†ç›–ä¸Šä¼ ã€‚
- ðŸ§  **æœ¬åœ°åµŒå…¥**ï¼šåŠ è½½æœ¬åœ° Qwen3-0.6B åµŒå…¥æ¨¡åž‹ç”Ÿæˆå‘é‡ï¼Œå¹¶å°†åˆ†ç‰‡å†™å…¥ Milvusã€‚
- ðŸ—‚ï¸ **Milvus å‘é‡åº“**ï¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ä¸Žé›†åˆï¼Œä¿å­˜ä¹¦åã€ç« èŠ‚ã€æ¥æºè·¯å¾„ç­‰å…ƒæ•°æ®ï¼Œæ–¹ä¾¿è¿½æº¯ï¼Œå¹¶æ”¯æŒä¼šè¯çº§é›†åˆè®°å¿†ã€‚
- ðŸ’¬ **FastAPI èŠå¤©æŽ¥å£**ï¼šæä¾›å¸¦ä¸Šä¸‹æ–‡çš„èŠå¤©æŽ¥å£ï¼Œè¿”å›žå¼•ç”¨æ¥æºï¼Œè®°å½•ç”¨æˆ·ä¸Žæ¨¡åž‹çš„æ¯æ¬¡å¯¹è¯ã€‚
- ðŸ› ï¸ **å¯é…ç½®åŒ–**ï¼šæ‰€æœ‰å…³é”®å‚æ•°ï¼ˆæ¨¡åž‹ã€APIã€Milvusã€æ—¥å¿—ç­‰ï¼‰å‡é€šè¿‡ `.env` é…ç½®ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡çŽ¯å¢ƒ

1. å®‰è£… Python 3.12ã€‚
2. å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆå¯ä½¿ç”¨ Poetry æˆ–ç›´æŽ¥ `pip install -r`ï¼Œæ­¤å¤„ä»¥ Poetry ä¸ºä¾‹ï¼‰ï¼š

   ```bash
   pip install poetry
   poetry install
   ```

3. å‡†å¤‡æœ¬åœ° Qwen3-0.6B åµŒå…¥æ¨¡åž‹ï¼Œå°†æ¨¡åž‹ç›®å½•è·¯å¾„é…ç½®åœ¨ `.env` ä¸­çš„ `EMBEDDING_MODEL_PATH`ã€‚
4. å¯åŠ¨ Milvus å®žä¾‹ï¼Œå¹¶è®°å½•è®¿é—®åœ°å€ã€è®¤è¯ä¿¡æ¯ï¼ˆå¯é€‰æ–¹å¼è§ä¸‹ï¼‰ã€‚

#### Milvus å¯åŠ¨æ–¹å¼

**Milvus å¯åŠ¨æ–¹å¼ï¼ˆdocker-compose æŽ¨èï¼‰**

æœ¬é¡¹ç›®å·²åœ¨ milvus/ ç›®å½•ä¸­æä¾›å®Œæ•´çš„ docker-compose.yml é…ç½®ï¼Œä»¥åŠå¿…éœ€çš„ volumes/ æ•°æ®ç›®å½•ã€‚
ä½ åªéœ€è¦è¿›å…¥è¯¥ç›®å½•å¹¶å¯åŠ¨æœåŠ¡å³å¯ã€‚

å¯åŠ¨ Milvusï¼ˆStandaloneï¼‰
```bash
cd milvus
docker compose up -d
```

å®¹å™¨å¯åŠ¨åŽå³å¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

Milvus æœåŠ¡ç«¯å£ï¼š127.0.0.1:19530

MinIO æŽ§åˆ¶å°ï¼šhttp://127.0.0.1:9001

å¦‚éœ€åœæ­¢æœåŠ¡ï¼š

```bash
docker compose down
```

**æœ¬åœ° milvus-serverï¼ˆMilvus Liteï¼‰**

å¦‚æžœæš‚æ—¶æ— æ³•ä½¿ç”¨ Dockerï¼Œå¯é€šè¿‡ `pip` å®‰è£… Milvus Liteï¼Œå¹¶ç›´æŽ¥åœ¨æœ¬æœºå¯åŠ¨ `milvus-server`ï¼š

```bash
pip install "milvus>=2.4.3"
milvus-server --host 127.0.0.1 --port 19530
```

è¯¥æ–¹å¼ä¼šåœ¨å½“å‰ç”¨æˆ·ç›®å½•ä¸‹åˆ›å»º `milvus` æ•°æ®æ–‡ä»¶å¤¹ï¼Œæ— éœ€é¢å¤–çš„ etcd / MinIO ä¾èµ–ï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•ä¸Žæœ¬åœ°å¼€å‘ã€‚

### 2. é…ç½® `.env`

å¤åˆ¶ `.env.example` ä¸º `.env`ï¼Œæ ¹æ®å®žé™…æƒ…å†µä¿®æ”¹ï¼š

```bash
cp .env.example .env
```

å…³é”®å­—æ®µè¯´æ˜Žï¼š

- `MILVUS_URI`ï¼šMilvus æœåŠ¡åœ°å€ï¼Œä¾‹å¦‚ `http://localhost:19530`ã€‚
- `EMBEDDING_MODEL_PATH` ä¸Ž `EMBEDDING_DIM`ï¼šæœ¬åœ°åµŒå…¥æ¨¡åž‹è·¯å¾„ä¸Žå‘é‡ç»´åº¦ã€‚
- `LLM_BASE_URL` / `LLM_MODEL_NAME` / `LLM_API_KEY`ï¼šOpenAI å…¼å®¹æ¨¡åž‹çš„æŽ¥å…¥ä¿¡æ¯ã€‚
- `LOG_DIRECTORY`ï¼šä¿å­˜å¯¹è¯æ—¥å¿—çš„ç›®å½•ã€‚

### 3. ä¸Šä¼ å°è¯´è‡³ Milvus

ä½¿ç”¨ `scripts/upload_novels.py` å°†æŒ‡å®šæ–‡ä»¶å¤¹ä¸­çš„ TXT å°è¯´å†™å…¥å‘é‡æ•°æ®åº“ï¼š

```bash
python scripts/upload_novels.py ./data/novels --collection novels
```

è„šæœ¬æµç¨‹ï¼š

1. éåŽ†ç›®å½•ä¸­çš„ `.txt` æ–‡ä»¶ã€‚
2. è¯¢é—®ä¹¦åï¼ˆå¯å›žè½¦ä½¿ç”¨æ–‡ä»¶åï¼‰ã€‚
3. è®¡ç®—æ–‡ä»¶å“ˆå¸Œå¹¶æ£€æµ‹ Milvus ä¸­æ˜¯å¦å·²å­˜åœ¨ã€‚
4. è‡ªåŠ¨åˆ†ç«  + é‡å åˆ‡åˆ†ï¼Œç”ŸæˆåµŒå…¥å¹¶å†™å…¥é›†åˆã€‚

å¦‚éœ€å¼ºåˆ¶é‡ä¼ ï¼Œå¯æ·»åŠ  `--force`ã€‚å½“æœªæ˜¾å¼ä¼ å…¥ `--collection` å‚æ•°æ—¶ï¼Œè„šæœ¬ä¼šåˆ—å‡ºå½“å‰æ‰€æœ‰é›†åˆåŠå…¶åŒ…å«çš„å°è¯´ï¼Œä¾¿äºŽé€‰æ‹©ç›®æ ‡é›†åˆï¼›ç›´æŽ¥å›žè½¦åˆ™æ²¿ç”¨é»˜è®¤é›†åˆåç§°ã€‚

### 3.1 å¿«é€Ÿä½“éªŒç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åœ¨æœ¬åœ°åˆ›å»ºä¸€æœ¬æ–‡æœ¬å°è¯´å¹¶å®Œæˆä¸Šä¼ ä¸Žå¯¹è¯ï¼š

```bash
# 1) ç”Ÿæˆç¤ºä¾‹å°è¯´ï¼ˆæˆ–ä½¿ç”¨ä½ è‡ªå·±çš„ TXT æ–‡ä»¶ï¼‰
python scripts/create_sample_novel.py examples

# 2) å°†å°è¯´ä¸Šä¼ åˆ° Milvusï¼ˆä¼šè‡ªåŠ¨è¯¢é—®ä¹¦åï¼Œå¯å›žè½¦ä½¿ç”¨é»˜è®¤å€¼ï¼‰
python scripts/upload_novels.py ./examples --collection demo --force

# 3) å¯åŠ¨ FastAPI æœåŠ¡
uvicorn app.main:app --reload

# 4) ä½¿ç”¨ curl ä½“éªŒèŠå¤©ï¼ˆéœ€åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œï¼‰
curl -X POST http://127.0.0.1:8000/api/chat \
  -H 'Content-Type: application/json' \
  -d '{"session_id": "demo", "collection": "demo", "query": "ä¸»è§’æ˜¯å¦‚ä½•é‡åˆ°ä¼™ä¼´çš„ï¼Ÿ"}'
```

æ‰§è¡Œå®ŒæˆåŽï¼Œç»ˆç«¯ä¼šè¿”å›žæ¨¡åž‹å›žç­”ä»¥åŠå¼•ç”¨çš„ç« èŠ‚ä¿¡æ¯ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ `logs/` ç›®å½•ä¸­æŸ¥çœ‹å¯¹åº”ä¼šè¯çš„æ—¥å¿—è®°å½•ã€‚è‹¥æƒ³å¿«é€Ÿè¯•éªŒï¼Œåªéœ€è¿è¡Œä¸€æ¬¡ `create_sample_novel.py`ï¼Œæ— éœ€è‡ªå·±å‡†å¤‡æ–‡æœ¬ã€‚

### 4. å¯åŠ¨ FastAPI æœåŠ¡

```bash
uvicorn app.main:app --reload
```

å¯ç”¨æŽ¥å£ï¼š

- `POST /api/chat`ï¼šæäº¤ `session_id`ã€ç”¨æˆ·é—®é¢˜ï¼Œå¯é€‰åœ°æŒ‡å®š `collection`ï¼›æœåŠ¡ä¼šè®°ä½ä¼šè¯æœ€è¿‘ä½¿ç”¨çš„é›†åˆï¼Œè¿”å›žå›žç­”ä¸Žå¼•ç”¨æ¥æºã€‚
- `GET /api/collections`ï¼šåˆ—å‡ºå½“å‰å¯ç”¨é›†åˆåŠå…¶åŒ…å«çš„å°è¯´ã€‚

### 5. æ—¥å¿—è®°å½•

æ‰€æœ‰å¯¹è¯åŽ†å²ä¼šå†™å…¥ `logs/interactions.log`ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€ä¼šè¯ IDã€ç”¨æˆ·é—®é¢˜ä¸Žæ¨¡åž‹å›žå¤æ‘˜è¦ã€‚

## é¡¹ç›®ç»“æž„

```
app/
  api/
    routes.py           # FastAPI è·¯ç”±
  models/
    api.py              # Pydantic æ•°æ®æ¨¡åž‹
  services/
    chat_history.py     # ä¼šè¯åŽ†å²ç®¡ç†
    embedding.py        # åµŒå…¥å‘é‡ç”Ÿæˆ
    hashing.py          # æ–‡ä»¶å“ˆå¸Œå·¥å…·
    rag.py              # RAG æµç¨‹å°è£…
    text_splitter.py    # ç« èŠ‚ + çª—å£åˆ‡åˆ†
    vector_store.py     # Milvus æ“ä½œå°è£…
  config.py             # å…¨å±€é…ç½®
  logger.py             # æ—¥å¿—é…ç½®
  main.py               # FastAPI å…¥å£
scripts/
  upload_novels.py      # å°è¯´ä¸Šä¼ è„šæœ¬
.env.example            # é…ç½®æ¨¡æ¿
pyproject.toml          # ä¾èµ–ä¸Žå…ƒæ•°æ®
README.md
```

## å…¶ä»–è¯´æ˜Ž

- FastAPI æœåŠ¡å’Œä¸Šä¼ è„šæœ¬å‡ä¾èµ– `.env` é…ç½®ã€‚
- è‹¥éœ€è¦å¤šé›†åˆç®¡ç†ï¼Œå¯åœ¨ä¸Šä¼ æ—¶ä½¿ç”¨ `--collection` æŒ‡å®šé›†åˆï¼Œå¹¶é€šè¿‡ `/api/collections` æŸ¥çœ‹å…¨å±€æ¦‚å†µã€‚
- ä¸Šä¼ è„šæœ¬å’Œ API å½“å‰ä¾èµ–å†…å­˜ä¸­çš„ä¼šè¯åŽ†å²ï¼Œå¦‚éœ€æŒä¹…åŒ–å¯åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•ã€‚
- åµŒå…¥æ¨¡åž‹ä¸Žå¯¹è¯æ¨¡åž‹å‡å¯æ›¿æ¢ä¸ºå…¶ä»–å…¼å®¹æ–¹æ¡ˆï¼Œåªéœ€è°ƒæ•´å¯¹åº”é…ç½®å³å¯ã€‚

æ¬¢è¿Žæ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›ä¸€æ­¥æ‰©å±•ï¼Œå¦‚åŠ å…¥ Web å‰ç«¯ã€é‰´æƒã€ä»»åŠ¡é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚
=======
# ChatRobot
>>>>>>> 368ceef8d994bcad42389398055b0e3d29284278
